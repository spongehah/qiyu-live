# start

[TOC]

# 1 直播带货秒杀功能的设计与实现

**什么是SKU？**

我们在提到一个产品时经常会说SKU，而且只要涉及到实物交易和库存管理就会有SKU的概念，这个词到底是什么意思呢？

**SKU**英文全称为Stock Keeping Unit，简称SKU，**是产品入库后一种编码归类方法，也是库存控制的最小单位。**可以是以件，盒，托盘等为单位，每种产品均对应唯一的SKU号，SKU号包含一种产品的品牌、型号、配置、等级、包装容量、单位、生产日期、保质期、用途、价格、产地等属性，一件产品的属性与其他产品都不一样，这样的商品就是一个单品。

> 简单来说，电商行业一件商品的信息就是一个SKU



**带货流程梳理**

直播间展示货物 -> 用户可以点击商品logo进行购买

 

关于商品带货这块的产品设计，我们可以在直播间中设计一块浮动的tab栏，用于展示相关的产品列表信息。

![img](image/6-直播带货秒杀功能的实现.assets/clip_image002.gif)

当用户进入直播间以后，可以通过产品列表去点击查看商品详情，然后使用虚拟币去进行购买即可。

**业务功能点分析**

- 商品信息表的设计（sku作为基本单位，类目，库存的设计），提供商品信息的基础接口，商品id的查询，商品信息的更新，商品信息的录入，商品信息的批量查询
- 手机（一级类目） -> 三星，华为，小米，苹果，vivo，oppo（二级类目）-> note 荣耀系列 .... 机型，内存，cpu等（三级类目）
- sku单位，名字细化到具体的商品名称（小米note11系列 最新手机 曲面屏 黑色系列），category
- 直播带货配置表（按照主播id为维度，去配置每个主播可以带货的sku信息），在直播间配置接口中返回主播是否有带货的权限
- 提供接口，查看主播本次带货的商品列表信息
- 提供接口，查看商品详情信息
- 商品下单的功能（加入购物车，待支付（如果没填写收货地址，需要填写收货地址），下单）
- 库存扣减的功能（如果订单超时未支付成功，我们得考虑库存回滚的问题）

# 2 直播带货秒杀功能的实现

## 2.1 数据表和实体类的准备

> 按理说带货功能应该单独放到一模块，但是当前我们的模块数量已经很多了，所以我们还是将其放到gift模块中

**创建数据表：**

```sql
-- Create syntax for TABLE 't_sku_info'
CREATE TABLE `t_sku_info` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '主键id',
  `sku_id` int unsigned NOT NULL DEFAULT '0' COMMENT 'sku id',
  `sku_price` int unsigned NOT NULL DEFAULT '0' COMMENT 'sku价格',
  `sku_code` varchar(250) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL COMMENT 'sku编码',
  `name` varchar(250) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL DEFAULT '' COMMENT '商品名称',
  `icon_url` varchar(500) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL COMMENT '缩略图',
  `original_icon_url` varchar(500) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL COMMENT '原图',
  `remark` varchar(500) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL COMMENT '商品描述',
  `status` tinyint unsigned NOT NULL DEFAULT '0' COMMENT '状态(0下架，1上架)',
  `category_id` int NOT NULL COMMENT '类目id',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='商品sku信息表';

-- Create syntax for TABLE 't_sku_order_info'
CREATE TABLE `t_sku_order_info` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `sku_id_list` varchar(500) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL,
  `user_id` bigint unsigned NOT NULL DEFAULT '0' COMMENT '用户id',
  `room_id` int unsigned NOT NULL DEFAULT '0' COMMENT '直播id',
  `status` int unsigned NOT NULL DEFAULT '0' COMMENT '状态',
  `extra` varchar(250) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL COMMENT '备注',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=23 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='商品订单表';

-- Create syntax for TABLE 't_sku_stock_info'
CREATE TABLE `t_sku_stock_info` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '主键id',
  `sku_id` int unsigned NOT NULL DEFAULT '0' COMMENT 'sku id',
  `stock_num` int unsigned NOT NULL DEFAULT '0' COMMENT 'sku库存',
  `status` tinyint unsigned NOT NULL DEFAULT '0' COMMENT '状态（0无效，1有效）',
  `version` int unsigned DEFAULT NULL COMMENT '乐观锁',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='sku库存表';

-- Create syntax for TABLE 't_anchor_shop_info'
CREATE TABLE `t_anchor_shop_info` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `anchor_id` int unsigned NOT NULL DEFAULT '0' COMMENT '主播id',
  `sku_id` int unsigned NOT NULL DEFAULT '0' COMMENT '商品sku id',
  `status` tinyint unsigned NOT NULL DEFAULT '1' COMMENT '有效（0无效，1有效）',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='带货主播权限配置表';

-- Create syntax for TABLE 't_category_info'
CREATE TABLE `t_category_info` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '主键id',
  `level` int unsigned NOT NULL DEFAULT '0' COMMENT '类目级别',
  `parent_id` int unsigned NOT NULL DEFAULT '0' COMMENT '父类目id',
  `category_name` varchar(250) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL COMMENT '类目名称',
  `status` tinyint unsigned NOT NULL DEFAULT '0' COMMENT '状态（0无效，1有效）',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='类目表';
```

**实体类对象的准备：**

**qiyu-live-api：**

```java
@Data
public class SkuInfoReqVO {
    
    private Long skuId;
    private Long anchorId;
}
```

```java
@Data
public class SkuInfoVO {

    private Long skuId;
    private Integer skuPrice;
    private String skuCode;
    private String name;
    private String iconUrl;
    private String originalIconUrl;
    private String remark;
}
```

```java
@Data
public class SkuDetailInfoVO {

    private Long skuId;
    private Integer skuPrice;
    private String skuCode;
    private String name;
    private String iconUrl;
    private String originalIconUrl;
    private String remark;
    //还有其它复杂数据
}
```

**qiyu-live-gift-interface：**

```java
@Data
public class SkuInfoDTO implements Serializable {
    @Serial
    private static final long serialVersionUID = 6682046584901973187L;
    private Long id;
    private Long skuId;
    private Integer skuPrice;
    private String skuCode;
    private String name;
    private String iconUrl;
    private String originalIconUrl;
    private Integer status;
    private String remark;
}
```

```java
@Data
public class SkuDetailInfoDTO implements Serializable {
    @Serial
    private static final long serialVersionUID = -1279033925266285109L;

    private Long skuId;
    private Integer skuPrice;
    private String skuCode;
    private String name;
    private String iconUrl;
    private String originalIconUrl;
    private String remark;
    //还有其它复杂数据
}
```

**qiyu-live-gift-provider：**

```java
@Data
@TableName("t_sku_info")
public class SkuInfoPO {
    
    @TableId(type = IdType.AUTO)
    private Long id;
    private Long skuId;
    private Integer skuPrice;
    private String skuCode;
    private String name;
    private String iconUrl;
    private String originalIconUrl;
    private Integer status;
    private String remark;
    private Date createTime;
    private Date updateTime;
}
```

```java
@Data
@TableName("t_anchor_shop_info")
public class AnchorShopInfoPO {
    @TableId(type = IdType.AUTO)
    private Integer id;
    private Long anchorId;
    private Long skuId;
    private Integer status;
    private Date createTime;
    private Date updateTime;
}
```

```java
@Data
@TableName("t_sku_stock_info")
public class SkuStockInfoPO {
    @TableId(type = IdType.AUTO)
    private Integer id;
    private Long stuId;
    private Integer stockNum;
    private Integer status;
    private Date createTime;
    private Date updateTime;
}
```

```java
@Data
@TableName("t_category_info")
public class CategoryInfoPO {
    
    @TableId(type = IdType.AUTO)
    private Integer level;
    private String categoryName;
    private Integer parentId;
    private Integer status;
    private Date createTime;
    private Date updateTime;
}
```

```java
@Mapper
public interface ISkuInfoMapper extends BaseMapper<SkuInfoPO> {
}
```

```java
@Mapper
public interface IAnchorShopInfoMapper extends BaseMapper<AnchorShopInfoPO> {
}
```

```java
@Mapper
public interface ISkuStockInfoMapper extends BaseMapper<SkuStockInfoPO> {
}
```

```java
@Mapper
public interface ICategoryInfoMapper extends BaseMapper<CategoryInfoPO> {
}
```

## 2.2 查询SKU商品列表和商品详情

**前端接口qiyu-live-api：**

```java
@RestController
@RequestMapping("/shop")
public class ShopInfoController {
    
    @Resource
    private IShopInfoService shopInfoService;
    
    @PostMapping("/listSkuInfo")
    public WebResponseVO listSkuInfo(Long anchorId) {
        return WebResponseVO.success(shopInfoService.queryByAnchorId(anchorId));
    }
    
    @PostMapping("detail")
    public WebResponseVO detail(SkuInfoReqVO reqVO) {
        return WebResponseVO.success(shopInfoService.detail(reqVO));
    }
}
```

```java
public interface IShopInfoService {

    /**
     * 根据anchorId查询商品列表
     */
    List<SkuInfoVO> queryByAnchorId(Long anchorId);

    /**
     * 根据skuId查询商品详情信息
     */
    SkuDetailInfoVO detail(SkuInfoReqVO skuInfoReqVO);
}
```

```java
@Service
public class ShopInfoServiceImpl implements IShopInfoService {
    
    @DubboReference
    private ISkuInfoRpc skuInfoRpc;

    @Override
    public List<SkuInfoVO> queryByAnchorId(Long anchorId) {
        List<SkuInfoDTO> skuInfoDTOS = skuInfoRpc.queryByAnchorId(anchorId);
        return ConvertBeanUtils.convertList(skuInfoDTOS, SkuInfoVO.class);
    }

    @Override
    public SkuDetailInfoVO detail(SkuInfoReqVO skuInfoReqVO) {
        return ConvertBeanUtils.convert(skuInfoRpc.queryBySkuId(skuInfoReqVO.getSkuId(), skuInfoReqVO.getAnchorId()), SkuDetailInfoVO.class);
    }
}
```



**qiyu-live-gift-provider：**

```java
public interface ISkuInfoRpc {

    /**
     * 根据anchorId查询skuInfoList
     */
    List<SkuInfoDTO> queryByAnchorId(Long anchorId);

    SkuDetailInfoDTO queryBySkuId(Long skuId, Long anchorId);
}
```

```java
@Configuration
@Conditional(RedisKeyLoadMatch.class)
public class GiftProviderCacheKeyBuilder extends RedisKeyBuilder {
    ...
    private static String SKU_DETAIL_INFO_MAP = "sku_detail_info_map";

    public String buildSkuDetailInfoMap(Long anchorId) {
        return super.getPrefix() + SKU_DETAIL_INFO_MAP + super.getSplitItem() + anchorId;
        
```

```java
@DubboService
public class SkuInfoRpcImpl implements ISkuInfoRpc {

    @Resource
    private ISkuInfoService skuInfoService;
    @Resource
    private IAnchorShopInfoService anchorShopInfoService;
    @Resource
    private RedisTemplate<String, Object> redisTemplate;
    @Resource
    private GiftProviderCacheKeyBuilder cacheKeyBuilder;

    @Override
    public List<SkuInfoDTO> queryByAnchorId(Long anchorId) {
        String cacheKey = cacheKeyBuilder.buildSkuDetailInfoMap(anchorId);
        List<SkuInfoDTO> skuInfoDTOS = redisTemplate.opsForHash().values(cacheKey).stream().map(x -> (SkuInfoDTO) x).collect(Collectors.toList());
        if (!CollectionUtils.isEmpty(skuInfoDTOS)) {
            if (skuInfoDTOS.get(0).getSkuId() == null) {
                return Collections.emptyList();
            }
            return skuInfoDTOS;
        }
        List<Long> skuIdList = anchorShopInfoService.querySkuIdsByAnchorId(anchorId);
        if (CollectionUtils.isEmpty(skuIdList)) {
            return Collections.emptyList();
        }
        skuInfoDTOS = ConvertBeanUtils.convertList(skuInfoService.queryBySkuIds(skuIdList), SkuInfoDTO.class);
        if (CollectionUtils.isEmpty(skuInfoDTOS)) {
            redisTemplate.opsForHash().put(cacheKey, -1, new PayProductDTO());
            redisTemplate.expire(cacheKey, 1L, TimeUnit.MINUTES);
            return Collections.emptyList();
        }
        // 使用Redis进行缓存
        Map<Long, SkuInfoDTO> skuInfoMap = skuInfoDTOS.stream().collect(Collectors.toMap(SkuInfoDTO::getSkuId, x -> x));
        redisTemplate.opsForHash().putAll(cacheKey, skuInfoMap);
        redisTemplate.expire(cacheKey, 30L, TimeUnit.MINUTES);
        return skuInfoDTOS;
    }

    @Override
    public SkuDetailInfoDTO queryBySkuId(Long skuId, Long anchorId) {
        String cacheKey = cacheKeyBuilder.buildSkuDetailInfoMap(anchorId);
        SkuInfoDTO skuInfoDTO = (SkuInfoDTO) redisTemplate.opsForHash().get(cacheKey, skuId);
        if (skuInfoDTO != null) {
            return ConvertBeanUtils.convert(skuInfoDTO, SkuDetailInfoDTO.class);
        }
        skuInfoDTO = ConvertBeanUtils.convert(skuInfoService.queryBySkuId(skuId), SkuInfoDTO.class);
        if (skuInfoDTO != null) {
            redisTemplate.opsForHash().put(cacheKey, skuId, skuInfoDTO);
        }
        return ConvertBeanUtils.convert(skuInfoDTO, SkuDetailInfoDTO.class);
    }
}
```

```java
public interface ISkuInfoService {

    /**
     * 使用skuIdList进行批量查询
     */
    List<SkuInfoPO> queryBySkuIds(List<Long> skuIdList);

    /**
     * 直接将SkuInfo当成SkuDetailInfo，根据skuId查询Info
     */
    SkuInfoPO queryBySkuId(Long skuId);
}
```

```java
@Service
public class SkuInfoServiceImpl implements ISkuInfoService {
    
    @Resource
    private ISkuInfoMapper skuInfoMapper;

    @Override
    public List<SkuInfoPO> queryBySkuIds(List<Long> skuIdList) {
        LambdaQueryWrapper<SkuInfoPO> queryWrapper = new LambdaQueryWrapper<>();
        queryWrapper.in(SkuInfoPO::getSkuId, skuIdList);
        queryWrapper.eq(SkuInfoPO::getStatus, CommonStatusEnum.VALID_STATUS.getCode());
        return skuInfoMapper.selectList(queryWrapper);
    }

    @Override
    public SkuInfoPO queryBySkuId(Long skuId) {
        LambdaQueryWrapper<SkuInfoPO> queryWrapper = new LambdaQueryWrapper<>();
        queryWrapper.in(SkuInfoPO::getSkuId, skuId);
        queryWrapper.eq(SkuInfoPO::getStatus, CommonStatusEnum.VALID_STATUS.getCode());
        queryWrapper.last("limit 1");
        return skuInfoMapper.selectOne(queryWrapper);
    }
}
```





























# end